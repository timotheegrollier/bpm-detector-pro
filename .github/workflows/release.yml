name: Build and Release

on:
  push:
    tags:
      - 'v*'

env:
  APP_NAME: BPM-Detector-Pro
  APP_ID: com.bpm.Detector

jobs:
  # ============================================
  # LINUX BUILD (Binary + DEB + RPM + Flatpak)
  # ============================================
  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev rubygems build-essential rpm libfuse2
          sudo gem install --no-document fpm

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-minimal.txt pyinstaller

      - name: Download FFmpeg
        run: |
          mkdir -p packaging/ffmpeg/linux
          curl -L https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz -o ffmpeg.tar.xz
          tar xf ffmpeg.tar.xz
          mv ffmpeg-*-amd64-static/ffmpeg packaging/ffmpeg/linux/ffmpeg
          chmod +x packaging/ffmpeg/linux/ffmpeg

      - name: Build Linux binary
        run: |
          chmod +x scripts/build_linux.sh
          ./scripts/build_linux.sh

      - name: Create DEB package
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          mkdir -p pkg-root/usr/bin
          mkdir -p pkg-root/usr/share/applications
          mkdir -p pkg-root/usr/share/icons/hicolor/scalable/apps
          
          cp dist/${{ env.APP_NAME }} pkg-root/usr/bin/bpm-detector-pro
          chmod +x pkg-root/usr/bin/bpm-detector-pro
          
          # Desktop file
          cat > pkg-root/usr/share/applications/bpm-detector-pro.desktop << 'EOF'
          [Desktop Entry]
          Name=BPM Detector Pro
          Comment=High-precision BPM detection for audio files
          Exec=bpm-detector-pro
          Icon=bpm-detector-pro
          Terminal=false
          Type=Application
          Categories=AudioVideo;Audio;Music;
          EOF
          
          # Icon
          cp packaging/assets/bpm-detector.svg pkg-root/usr/share/icons/hicolor/scalable/apps/bpm-detector-pro.svg
          
          fpm -s dir -t deb \
            -n bpm-detector-pro \
            -v "$VERSION" \
            --description "High-precision BPM detection for audio files" \
            --url "https://github.com/${{ github.repository }}" \
            --license "MIT" \
            --maintainer "BPM Detector Pro Team" \
            -C pkg-root \
            .
          
          mv *.deb dist/bpm-detector-pro_${VERSION}_amd64.deb

      - name: Create RPM package
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          
          fpm -s dir -t rpm \
            -n bpm-detector-pro \
            -v "$VERSION" \
            --description "High-precision BPM detection for audio files" \
            --url "https://github.com/${{ github.repository }}" \
            --license "MIT" \
            --maintainer "BPM Detector Pro Team" \
            -C pkg-root \
            .
          
          mv *.rpm dist/bpm-detector-pro-${VERSION}.x86_64.rpm

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-builds
          path: |
            dist/${{ env.APP_NAME }}
            dist/*.deb
            dist/*.rpm

  # ============================================
  # FLATPAK BUILD (uses pre-built binary)
  # ============================================
  build-flatpak:
    needs: build-linux
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Download Linux binary
        uses: actions/download-artifact@v4
        with:
          name: linux-builds
          path: artifacts

      - name: Prepare binary for Flatpak
        run: |
          mkdir -p flatpak-build
          cp artifacts/${{ env.APP_NAME }} flatpak-build/
          chmod +x flatpak-build/${{ env.APP_NAME }}

      - name: Install Flatpak tools
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder
          sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          sudo flatpak install -y flathub org.freedesktop.Platform//23.08 org.freedesktop.Sdk//23.08

      - name: Create simplified Flatpak manifest
        run: |
          cat > flatpak-manifest.yml << 'EOF'
          app-id: com.bpm.Detector
          runtime: org.freedesktop.Platform
          runtime-version: '23.08'
          sdk: org.freedesktop.Sdk
          command: bpm-detector-pro
          finish-args:
            - --socket=wayland
            - --socket=x11
            - --socket=fallback-x11
            - --share=ipc
            - --filesystem=home:ro
            - --filesystem=xdg-music:ro
            - --device=dri
          modules:
            - name: bpm-detector-pro
              buildsystem: simple
              build-commands:
                - install -Dm755 BPM-Detector-Pro /app/bin/bpm-detector-pro
                - install -Dm644 bpm-detector-pro.desktop /app/share/applications/com.bpm.Detector.desktop
                - install -Dm644 bpm-detector.svg /app/share/icons/hicolor/scalable/apps/com.bpm.Detector.svg
              sources:
                - type: file
                  path: flatpak-build/BPM-Detector-Pro
                - type: file
                  path: packaging/assets/bpm-detector.svg
                - type: file
                  path: flatpak-desktop.desktop
                  dest-filename: bpm-detector-pro.desktop
          EOF
          
          # Create desktop file
          cat > flatpak-desktop.desktop << 'EOF'
          [Desktop Entry]
          Type=Application
          Name=BPM Detector Pro
          Comment=High-precision BPM detection for audio files
          Exec=bpm-detector-pro
          Icon=com.bpm.Detector
          Categories=Audio;AudioVideo;Music;
          Terminal=false
          EOF

      - name: Build Flatpak
        run: |
          flatpak-builder --force-clean --repo=repo build-dir flatpak-manifest.yml
          flatpak build-bundle repo ${{ env.APP_NAME }}.flatpak ${{ env.APP_ID }}

      - name: Upload Flatpak artifact
        uses: actions/upload-artifact@v4
        with:
          name: flatpak-build
          path: ${{ env.APP_NAME }}.flatpak

  # ============================================
  # WINDOWS BUILD (single .exe, no ZIP needed)
  # ============================================
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-minimal.txt pyinstaller

      - name: Download FFmpeg
        run: |
          New-Item -ItemType Directory -Force -Path packaging/ffmpeg/windows
          Invoke-WebRequest -Uri "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip" -OutFile ffmpeg.zip
          Expand-Archive -Path ffmpeg.zip -DestinationPath ffmpeg-extract
          $ffmpegExe = Get-ChildItem -Path ffmpeg-extract -Recurse -Name ffmpeg.exe | Select-Object -First 1
          Copy-Item "ffmpeg-extract/$ffmpegExe" packaging/ffmpeg/windows/ffmpeg.exe

      - name: Build Windows single-file EXE
        env:
          USE_ONEDIR: '0'
          CREATE_ZIP: '0'
        run: |
          .\scripts\build_windows.ps1

      - name: Verify build output
        run: |
          $exePath = "dist/${{ env.APP_NAME }}.exe"
          if (-not (Test-Path $exePath)) {
            Write-Error "Build failed: $exePath not found"
            exit 1
          }
          $size = (Get-Item $exePath).Length / 1MB
          Write-Host ("Build OK: $exePath ({0:N1} MB)" -f $size)

      - name: Rename for release
        run: |
          Copy-Item "dist/${{ env.APP_NAME }}.exe" "dist/${{ env.APP_NAME }}-Windows-x64.exe"

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: dist/${{ env.APP_NAME }}-Windows-x64.exe
          if-no-files-found: error

  # ============================================
  # MACOS BUILD (.app + .dmg)
  # ============================================
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-minimal.txt pyinstaller
          brew install create-dmg

      - name: Download FFmpeg
        run: |
          mkdir -p packaging/ffmpeg/macos
          curl -L https://evermeet.cx/ffmpeg/getrelease/ffmpeg/zip -o ffmpeg.zip
          unzip ffmpeg.zip
          mv ffmpeg packaging/ffmpeg/macos/ffmpeg
          chmod +x packaging/ffmpeg/macos/ffmpeg

      - name: Build macOS app
        run: |
          pyinstaller --noconfirm --clean bpm-detector.spec
          
      - name: Create DMG
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          mkdir -p dmg-content
          cp -r "dist/${{ env.APP_NAME }}.app" dmg-content/ 2>/dev/null || cp dist/${{ env.APP_NAME }} dmg-content/
          
          # Create DMG
          create-dmg \
            --volname "${{ env.APP_NAME }}" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --hide-extension "${{ env.APP_NAME }}" \
            --app-drop-link 450 185 \
            "dist/${{ env.APP_NAME }}-macOS.dmg" \
            "dmg-content/" || true
          
          # Fallback: create simple DMG if create-dmg fails
          if [ ! -f "dist/${{ env.APP_NAME }}-macOS.dmg" ]; then
            hdiutil create -volname "${{ env.APP_NAME }}" -srcfolder dmg-content -ov -format UDZO "dist/${{ env.APP_NAME }}-macOS.dmg"
          fi

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: dist/${{ env.APP_NAME }}-macOS.dmg

  # ============================================
  # CREATE GITHUB RELEASE
  # ============================================
  release:
    needs: [build-linux, build-flatpak, build-windows, build-macos]
    # Continue even if optional builds fail
    if: always() && needs.build-linux.result == 'success' && needs.build-windows.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          VERSION=${GITHUB_REF#refs/tags/v}
          
          # Linux
          cp artifacts/linux-builds/${{ env.APP_NAME }} release/${{ env.APP_NAME }}-Linux-x64
          chmod +x release/${{ env.APP_NAME }}-Linux-x64
          cp artifacts/linux-builds/*.deb release/ || true
          cp artifacts/linux-builds/*.rpm release/ || true
          
          # Windows (single .exe)
          cp "artifacts/windows-build/${{ env.APP_NAME }}-Windows-x64.exe" "release/${{ env.APP_NAME }}-Windows-x64.exe"
          
          # macOS
          cp artifacts/macos-build/${{ env.APP_NAME }}-macOS.dmg release/ || true
          
          # Flatpak (optional)
          cp artifacts/flatpak-build/${{ env.APP_NAME }}.flatpak release/ || true
          
          ls -la release/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: BPM Detector Pro ${{ github.ref_name }}
          body: |
            ## ðŸŽµ BPM Detector Pro ${{ github.ref_name }}
            
            **NOUVELLE VERSION OPTIMISÃ‰E** ðŸš€
            
            - **DÃ©marrage instantanÃ©** (< 2s)
            - **Taille rÃ©duite** (~50 Mo)
            - **Performance accrue**
            
            ---
            
            ### ðŸ“¥ TÃ©lÃ©chargements
            
            | Plateforme | Format | Fichier | Instructions |
            |------------|--------|---------|--------------|
            | ðŸ§ **Linux** | Binaire | `BPM-Detector-Pro-Linux-x64` | `chmod +x` puis exÃ©cutez |
            | ðŸ§ **Linux** | DEB | `bpm-detector-pro_*.deb` | `sudo apt install ./fichier.deb` |
            | ðŸ§ **Linux** | RPM | `bpm-detector-pro-*.rpm` | `sudo dnf install ./fichier.rpm` |
            | ðŸ§ **Linux** | Flatpak | `BPM-Detector-Pro.flatpak` | `flatpak install ./fichier.flatpak` |
            | ðŸªŸ **Windows** | EXE | `BPM-Detector-Pro-Windows-x64.exe` | Double-clic pour lancer |
            | ðŸŽ **macOS** | DMG | `BPM-Detector-Pro-macOS.dmg` | Ouvrez et glissez dans Applications |
            
            ---
            
            ### âœ¨ FonctionnalitÃ©s
            - ðŸŽ¯ DÃ©tection BPM ultra-prÃ©cise (algorithme hybride ACF/Beats)
            - ðŸ–¥ï¸ Interface graphique moderne (Fast GUI)
            - ðŸ“¦ FFmpeg intÃ©grÃ© - aucune dÃ©pendance externe
            - ðŸ”Š Tous formats audio supportÃ©s (MP3, FLAC, WAV, M4A, OGG...)
            - âš¡ Portable - aucune installation requise
            
            ---
            
            ### ðŸ“¦ Installation par gestionnaire de paquets
            
            **Debian/Ubuntu (apt):**
            ```bash
            sudo apt install ./bpm-detector-pro_*_amd64.deb
            ```
            
            **Fedora/RHEL (dnf):**
            ```bash
            sudo dnf install ./bpm-detector-pro-*.x86_64.rpm
            ```
            
            **Flatpak:**
            ```bash
            flatpak install --user ./BPM-Detector-Pro.flatpak
            ```
            
            ---
            Voir le [README](https://github.com/${{ github.repository }}/blob/main/README.md) pour la documentation complÃ¨te.
          files: |
            release/*
          draft: false
          prerelease: false
