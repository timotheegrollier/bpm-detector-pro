name: Build and Release

on:
  push:
    tags:
      - 'v*'

env:
  APP_NAME: BPM-detector
  APP_ID: com.bpm.Detector

jobs:
  # ============================================
  # RELEASE SOURCE VALIDATION
  # ============================================
  validate-release-source:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Validate tag points to default branch HEAD
        env:
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          git fetch --no-tags origin "$DEFAULT_BRANCH"
          TAG_SHA="$(git rev-parse HEAD)"
          BRANCH_SHA="$(git rev-parse "origin/$DEFAULT_BRANCH")"
          echo "Tag ref: $GITHUB_REF_NAME"
          echo "Tag SHA: $TAG_SHA"
          echo "Default branch SHA (origin/$DEFAULT_BRANCH): $BRANCH_SHA"
          if [ "$TAG_SHA" != "$BRANCH_SHA" ]; then
            echo "::error::Tag $GITHUB_REF_NAME is not at origin/$DEFAULT_BRANCH HEAD. Push the branch commit and tag together to avoid stale release artifacts."
            exit 1
          fi

      - name: Validate app version file matches tag
        run: |
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          APP_VERSION="$(python3 -c 'from app_version import APP_VERSION; print(APP_VERSION)')"
          echo "Tag version: $TAG_VERSION"
          echo "app_version.py: $APP_VERSION"
          if [ "$APP_VERSION" != "$TAG_VERSION" ]; then
            echo "::error::app_version.py ($APP_VERSION) must match tag version ($TAG_VERSION) before release."
            exit 1
          fi

  # ============================================
  # LINUX BUILD (Binary + DEB + RPM + Flatpak)
  # ============================================
  build-linux:
    needs: validate-release-source
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev rubygems build-essential rpm libfuse2
          sudo gem install --no-document fpm

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-minimal.txt pyinstaller

      - name: Download FFmpeg
        run: |
          mkdir -p packaging/ffmpeg/linux
          curl -L https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz -o ffmpeg.tar.xz
          tar xf ffmpeg.tar.xz
          mv ffmpeg-*-amd64-static/ffmpeg packaging/ffmpeg/linux/ffmpeg
          chmod +x packaging/ffmpeg/linux/ffmpeg

      - name: Build Linux binary
        run: |
          chmod +x scripts/build_linux.sh
          USE_STRIP=1 ./scripts/build_linux.sh

      - name: Create DEB package
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          mkdir -p pkg-root/usr/bin
          mkdir -p pkg-root/usr/share/applications
          mkdir -p pkg-root/usr/share/icons/hicolor/scalable/apps
          
          cp dist/${{ env.APP_NAME }} pkg-root/usr/bin/bpm-detector
          chmod +x pkg-root/usr/bin/bpm-detector
          
          # Desktop file
          cat > pkg-root/usr/share/applications/bpm-detector.desktop << 'EOF'
          [Desktop Entry]
          Name=BPM-detector
          Comment=High-precision BPM detection for audio files
          Exec=bpm-detector
          Icon=bpm-detector
          Terminal=false
          Type=Application
          Categories=AudioVideo;Audio;Music;
          EOF
          
          # Icon
          cp packaging/assets/bpm-detector.svg pkg-root/usr/share/icons/hicolor/scalable/apps/bpm-detector.svg
          
          fpm -s dir -t deb \
            -n bpm-detector \
            -v "$VERSION" \
            --deb-compression xz \
            --description "High-precision BPM detection for audio files" \
            --url "https://github.com/${{ github.repository }}" \
            --license "MIT" \
            --maintainer "Timothee Grollier" \
            -C pkg-root \
            .
          
          mv *.deb dist/bpm-detector_${VERSION}_amd64.deb

      - name: Create RPM package
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          
          fpm -s dir -t rpm \
            -n bpm-detector \
            -v "$VERSION" \
            --rpm-compression xz \
            --description "High-precision BPM detection for audio files" \
            --url "https://github.com/${{ github.repository }}" \
            --license "MIT" \
            --maintainer "Timothee Grollier" \
            -C pkg-root \
            .
          
          mv *.rpm dist/bpm-detector-${VERSION}.x86_64.rpm

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-builds
          path: |
            dist/${{ env.APP_NAME }}
            dist/*.deb
            dist/*.rpm

  # ============================================
  # FLATPAK BUILD (uses pre-built binary)
  # ============================================
  build-flatpak:
    needs: build-linux
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Download Linux binary
        uses: actions/download-artifact@v4
        with:
          name: linux-builds
          path: artifacts

      - name: Prepare binary for Flatpak
        run: |
          mkdir -p flatpak-build
          cp artifacts/${{ env.APP_NAME }} flatpak-build/
          chmod +x flatpak-build/${{ env.APP_NAME }}

      - name: Install Flatpak tools
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder
          sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          sudo flatpak install -y flathub org.freedesktop.Platform//23.08 org.freedesktop.Sdk//23.08

      - name: Create simplified Flatpak manifest
        run: |
          cat > flatpak-manifest.yml << 'EOF'
          app-id: com.bpm.Detector
          runtime: org.freedesktop.Platform
          runtime-version: '23.08'
          sdk: org.freedesktop.Sdk
          command: bpm-detector
          finish-args:
            - --socket=wayland
            - --socket=x11
            - --socket=fallback-x11
            - --share=ipc
            - --filesystem=home:ro
            - --filesystem=xdg-music:ro
            - --device=dri
          modules:
            - name: bpm-detector
              buildsystem: simple
              build-commands:
                - install -Dm755 BPM-detector /app/bin/bpm-detector
                - install -Dm644 bpm-detector.desktop /app/share/applications/com.bpm.Detector.desktop
                - install -Dm644 bpm-detector.svg /app/share/icons/hicolor/scalable/apps/com.bpm.Detector.svg
              sources:
                - type: file
                  path: flatpak-build/BPM-detector
                - type: file
                  path: packaging/assets/bpm-detector.svg
                - type: file
                  path: flatpak-desktop.desktop
                  dest-filename: bpm-detector.desktop
          EOF
          
          # Create desktop file
          cat > flatpak-desktop.desktop << 'EOF'
          [Desktop Entry]
          Type=Application
          Name=BPM-detector
          Comment=High-precision BPM detection for audio files
          Exec=bpm-detector
          Icon=com.bpm.Detector
          Categories=Audio;AudioVideo;Music;
          Terminal=false
          EOF

      - name: Build Flatpak
        run: |
          flatpak-builder --force-clean --repo=repo build-dir flatpak-manifest.yml
          flatpak build-bundle repo ${{ env.APP_NAME }}.flatpak ${{ env.APP_ID }}

      - name: Upload Flatpak artifact
        uses: actions/upload-artifact@v4
        with:
          name: flatpak-build
          path: ${{ env.APP_NAME }}.flatpak

  # ============================================
  # WINDOWS BUILD (onedir + ZIP to avoid DLL issues)
  # ============================================
  build-windows:
    needs: validate-release-source
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-minimal.txt pyinstaller

      - name: Download FFmpeg
        run: |
          New-Item -ItemType Directory -Force -Path packaging/ffmpeg/windows
          Invoke-WebRequest -Uri "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip" -OutFile ffmpeg.zip
          Expand-Archive -Path ffmpeg.zip -DestinationPath ffmpeg-extract
          $ffmpegExe = Get-ChildItem -Path ffmpeg-extract -Recurse -Name ffmpeg.exe | Select-Object -First 1
          Copy-Item "ffmpeg-extract/$ffmpegExe" packaging/ffmpeg/windows/ffmpeg.exe

      - name: Build Windows (onedir mode)
        run: |
          .\scripts\build_windows.ps1

      - name: Verify build & create ZIP
        run: |
          $dirPath = "dist/${{ env.APP_NAME }}"
          $exePath = "$dirPath/${{ env.APP_NAME }}.exe"
          $internalDir = "$dirPath/_internal"
          if (-not (Test-Path $exePath)) {
            Write-Error "Build failed: $exePath not found"
            exit 1
          }
          if (-not (Test-Path $internalDir)) {
            Write-Error "Build failed: $internalDir not found"
            exit 1
          }
          $pythonDll = Get-ChildItem -Path $internalDir -Filter "python*.dll" -File |
            Where-Object { $_.Name -match '^python\d+\.dll$' } |
            Select-Object -First 1
          if (-not $pythonDll) {
            Write-Error "Build failed: python runtime DLL not found in $internalDir"
            exit 1
          }
          $requiredDlls = @($pythonDll.Name, "vcruntime140.dll", "vcruntime140_1.dll")
          foreach ($dllName in $requiredDlls) {
            $dllPath = "$internalDir/$dllName"
            if (-not (Test-Path $dllPath)) {
              Write-Error "Build failed: required DLL missing: $dllPath"
              exit 1
            }
          }
          if (-not (Test-Path "$internalDir/msvcp140.dll")) {
            Write-Warning "Optional DLL missing: $internalDir/msvcp140.dll (target machine may require VC++ Redistributable)"
          }
          $size = (Get-Item $exePath).Length / 1MB
          Write-Host ("Build OK: $exePath ({0:N1} MB)" -f $size)
          
          $zipPath = "dist/${{ env.APP_NAME }}-Windows-x64.zip"
          if (-not (Test-Path $zipPath)) {
             Write-Error "ZIP not found: $zipPath"
             exit 1
          }
          $zipSize = (Get-Item $zipPath).Length / 1MB
          Write-Host ("ZIP: $zipPath ({0:N1} MB)" -f $zipSize)

      - name: Install Inno Setup
        run: |
          choco install innosetup --no-progress -y

      - name: Build Windows installer
        shell: pwsh
        run: |
          .\scripts\build_windows_installer.ps1 -InputDir "dist/${{ env.APP_NAME }}" -OutputDir "dist"

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: |
            dist/${{ env.APP_NAME }}-Windows-x64.zip
            dist/${{ env.APP_NAME }}-Setup-Windows-x64.exe
          if-no-files-found: error

  # ============================================
  # MACOS BUILD (.app + .dmg)
  # ============================================
  build-macos:
    needs: validate-release-source
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-minimal.txt pyinstaller
          brew install create-dmg

      - name: Download FFmpeg
        run: |
          mkdir -p packaging/ffmpeg/macos
          curl -L https://evermeet.cx/ffmpeg/getrelease/ffmpeg/zip -o ffmpeg.zip
          unzip ffmpeg.zip
          mv ffmpeg packaging/ffmpeg/macos/ffmpeg
          chmod +x packaging/ffmpeg/macos/ffmpeg

      - name: Build macOS app
        run: |
          pyinstaller --noconfirm --clean bpm-detector.spec
          
      - name: Create DMG
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          mkdir -p dmg-content
          cp -r "dist/${{ env.APP_NAME }}.app" dmg-content/ 2>/dev/null || cp dist/${{ env.APP_NAME }} dmg-content/
          
          # Create DMG
          create-dmg \
            --volname "${{ env.APP_NAME }}" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --hide-extension "${{ env.APP_NAME }}" \
            --app-drop-link 450 185 \
            "dist/${{ env.APP_NAME }}-macOS.dmg" \
            "dmg-content/" || true
          
          # Fallback: create simple DMG if create-dmg fails
          if [ ! -f "dist/${{ env.APP_NAME }}-macOS.dmg" ]; then
            hdiutil create -volname "${{ env.APP_NAME }}" -srcfolder dmg-content -ov -format UDZO "dist/${{ env.APP_NAME }}-macOS.dmg"
          fi

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: dist/${{ env.APP_NAME }}-macOS.dmg

  # ============================================
  # CREATE GITHUB RELEASE
  # ============================================
  release:
    needs: [build-linux, build-flatpak, build-windows, build-macos]
    # Continue even if optional builds fail
    if: always() && needs.build-linux.result == 'success' && needs.build-windows.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          VERSION=${GITHUB_REF#refs/tags/v}
          
          # Linux
          cp artifacts/linux-builds/${{ env.APP_NAME }} release/${{ env.APP_NAME }}-Linux-x64
          chmod +x release/${{ env.APP_NAME }}-Linux-x64
          tar -C release -cJf release/${{ env.APP_NAME }}-Linux-x64.tar.xz ${{ env.APP_NAME }}-Linux-x64
          rm -f release/${{ env.APP_NAME }}-Linux-x64
          cp artifacts/linux-builds/*.deb release/ || true
          cp artifacts/linux-builds/*.rpm release/ || true
          
          # Windows (ZIP with onedir folder)
          cp "artifacts/windows-build/${{ env.APP_NAME }}-Windows-x64.zip" "release/${{ env.APP_NAME }}-Windows-x64.zip"
          cp "artifacts/windows-build/${{ env.APP_NAME }}-Setup-Windows-x64.exe" "release/${{ env.APP_NAME }}-Setup-Windows-x64.exe"
          
          # macOS
          cp artifacts/macos-build/${{ env.APP_NAME }}-macOS.dmg release/ || true
          
          # Flatpak (optional)
          cp artifacts/flatpak-build/${{ env.APP_NAME }}.flatpak release/ || true

          APP_VERSION="$(python3 -c 'from app_version import APP_VERSION; print(APP_VERSION)')"
          GUI_SHA="$(sha256sum bpm_gui.py | awk '{print $1}')"
          {
            echo "tag=${GITHUB_REF_NAME}"
            echo "commit=${GITHUB_SHA}"
            echo "app_version=${APP_VERSION}"
            echo "bpm_gui_sha256=${GUI_SHA}"
            echo "built_at_utc=$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          } > release/build-info.txt
          
          ls -la release/

      - name: Generate SHA256 checksums
        run: |
          python3 scripts/generate_checksums.py release --output release/checksums.txt --relative-to release
          cat release/checksums.txt

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: BPM-detector ${{ github.ref_name }}
          body: |
            ## BPM-detector ${{ github.ref_name }}

            Multi-platform release for Linux, Windows, and macOS.

            ### Highlights
            - Windows: portable ZIP and installer are built from the same ONEDIR payload
            - Release integrity: `checksums.txt` now published with SHA256 hashes for every artifact
            - Source traceability: `build-info.txt` includes tag, commit SHA, app version, and GUI file checksum

            ### Downloads

            | Platform | Format | File | Instructions |
            |----------|--------|------|--------------|
            | Linux | Binary | `BPM-detector-Linux-x64.tar.xz` | Extract, then run `chmod +x BPM-detector-Linux-x64 && ./BPM-detector-Linux-x64` |
            | Linux | DEB | `bpm-detector_*.deb` | `sudo apt install ./file.deb` |
            | Linux | RPM | `bpm-detector-*.rpm` | `sudo dnf install ./file.rpm` |
            | Linux | Flatpak | `BPM-detector.flatpak` | `flatpak install ./file.flatpak` |
            | Windows | Installer | `BPM-detector-Setup-Windows-x64.exe` | Run setup, then launch from Start Menu/Desktop shortcut |
            | Windows | ZIP | `BPM-detector-Windows-x64.zip` | Extract all files, then run `BPM-detector.exe` |
            | macOS | DMG | `BPM-detector-macOS.dmg` | Open and drag to Applications |

            ### Package Manager Install

            **Debian/Ubuntu (apt):**
            ```bash
            sudo apt install ./bpm-detector_*_amd64.deb
            ```

            **Fedora/RHEL (dnf):**
            ```bash
            sudo dnf install ./bpm-detector-*.x86_64.rpm
            ```

            **Flatpak:**
            ```bash
            flatpak install --user ./BPM-detector.flatpak
            ```

            ### Integrity Verification

            `checksums.txt` is included in release assets.

            **Linux/macOS:**
            ```bash
            sha256sum -c checksums.txt
            ```

            **Windows (PowerShell):**
            ```powershell
            Get-FileHash .\BPM-detector-Setup-Windows-x64.exe -Algorithm SHA256
            ```
            Compare the hash with the matching line in `checksums.txt`.

            Full documentation: [README](https://github.com/${{ github.repository }}/blob/main/README.md)
          files: |
            release/*
          draft: false
          prerelease: false
